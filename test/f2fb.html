<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<style>
  body {
    margin: 0;
  }

  .video-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .video-container-inner {
    /* Make video to at least 100% wide and tall */
    min-width: 100%;
    min-height: 100%;

    /* Setting width & height to auto prevents the browser from stretching or squishing the video */
    width: auto;
    height: auto;

    /* Center the video */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .video-circle {
    position: relative;
    z-index: 1000;
    object-fit: cover;
    width: 200px;
    height: 200px;
    margin: 18px;
    border: 3px solid white;  
  }

  .fps-display {
    position: absolute;
    color: white;
    top: 10px;
    z-index: 1000;
    width: 150px;
    height: 60px;
    right:150px;
    iborder: 3px solid white;  
    font-size: 40px;
  }

  #mainvideo{
    position: absolute;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100%;
  }

</style>


  <div id="mainvideo"> </div>
  <div id="video-over" class="video-circle"> </div>
  <div id="fps-out" class="fps-display"> </div>

  
  
<canvas id="canid" width="1280" height="720" style="display:none;width:320px; height:180px;  border: 3px solid orangered;"> </canvas>

<script>

  function funk() {
    var randomColor = Math.floor(Math.random() * 16777215).toString(16);
    var canv = document.getElementById("canid");
    var ctx = document.getElementById("canid").getContext('2d');
    ctx.fillStyle = '#' + randomColor;
    ctx.beginPath();
    ctx.moveTo(Math.random() * canv.width, Math.random() * canv.height);
    ctx.lineTo(Math.random() * canv.width, Math.random() * canv.height);
    ctx.lineTo(Math.random() * canv.width, Math.random() * canv.height);
    ctx.fill();
  }
  setInterval(funk, 33);

  var localTracks = {
    videoTrack: null,
    audioTrack: null
  };

  const paramsString = document.location.search;
  const searchParams = new URLSearchParams(paramsString);
  const codec = searchParams.get("codec");
  var appid = searchParams.get("appid");
  var channel = searchParams.get("channel");
  var width=1280;
  var height=720;

  if (searchParams.get("height")) {
      height = parseInt(searchParams.get("height"));
  }

  if (searchParams.get("width")) {
      width = parseInt(searchParams.get("width"));
  }

  var canv=document.getElementById("canid");
  canv.width=width;
  canv.height=height;

  var agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: codec });
  var uid = null;

  async function agora() {
    agoraClient.on("user-joined", async (user) => {
      console.warn("user-joined", user);
    });

    agoraClient.on("user-published", async (user, mediaType) => {
      await agoraClient.subscribe(user, mediaType);
      if (mediaType === 'audio') {
 //       user.audioTrack.play();
      }
      else if (mediaType === 'video') {
        user.videoTrack.play("mainvideo");
      }
    });

    var stream = document.getElementById("canid").captureStream(30);
    [uid,  localTracks.audioTrack, localTracks.videoTrack] = await Promise.all([
      agoraClient.join(appid, channel, null, null),
      AgoraRTC.createMicrophoneAudioTrack(),
      AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0],  width: { max: height }, height: { max: height }, frameRate: 30, bitrateMin: 500, bitrateMax: 1200 })
//      AgoraRTC.createCameraVideoTrack({ width: { max: height }, height: { max: height }, frameRate: 30, bitrateMin: 500, bitrateMax: 1200 })
    ]);

    await agoraClient.publish(Object.values(localTracks));
    localTracks.videoTrack.play("video-over");

  }


  async function monitorCallStats() {
    try    
      {
        var outgoingStats = agoraClient.getLocalVideoStats();
        var fps=outgoingStats.sendFrameRate;
        if (fps) {
          document.getElementById("fps-out").innerHTML="FPS: "+fps;
        }

        /*
        if (agoraClient._p2pChannel.localTrackMap.get("videoTrack")) {
            await agoraClient._p2pChannel.connection.peerConnection.getStats(agoraClient._p2pChannel.localTrackMap.get("videoTrack").track).then(async stats => {
              await stats.forEach(report => {
                if (report.type === "outbound-rtp" && report.kind === "video") {
                  var totalEncodeTime = report["totalEncodeTime"];
                  var framesEncoded = report["framesEncoded"];
                  var totalEncodeTimeChange = 1000*(totalEncodeTime - _clientStatsMap.LastEncodeTime);
                  var framesEncodedChange =  (framesEncoded -  _clientStatsMap.LastFramesEncoded);
                  _clientStatsMap.EncodeTime = (totalEncodeTimeChange/framesEncodedChange);
                  if (framesEncodedChange>100) {
                    _clientStatsMap.LastEncodeTime=totalEncodeTime;
                    _clientStatsMap.LastFramesEncoded=framesEncoded;
                     }
                  }
              })
            });      
          
        }
          */
      } catch(e) {
        console.error(e);
      }

      setTimeout(() => {
          monitorCallStats();
      }, 500);
  }
  function run() {
    setTimeout(agora,200);
    monitorCallStats();

  }

  

  window.onload = run;

</script>